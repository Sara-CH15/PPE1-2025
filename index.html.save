#!/bin/bash

# Vérifier qu'on a un argument
if [ $# -ne 1 ]; then
    echo "Usage: $0 <fichier_urls>" >&2
    exit 1
fi

FICHIER_URLS=$1

# Vérifier que le fichier existe
if [ ! -f "$FICHIER_URLS" ]; then
    echo "Erreur: le fichier $FICHIER_URLS n'existe pas" >&2
    exit 1
fi

# Début du document HTML avec Bulma
echo "<!DOCTYPE html>"
echo "<html lang=\"fr\">"
echo "<head>"
echo "    <meta charset=\"UTF-8\">"
echo "    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">"
echo "    <title>Tableau des URLs - Projet Robot</title>"
echo "    <link rel=\"stylesheet\" href=\"https://cdn.jsdelivr.net/npm/bulma@1.0.4/css/bulma.min.css\">"
echo "</head>"
echo "<body>"

# En-tête de la page
echo "    <section class=\"hero is-info\">"
echo "        <div class=\"hero-body\">"
echo "            <div class=\"container\">"
echo "                <h1 class=\"title\">Tableau des URLs analysées</h1>"
echo "                <h2 class=\"subtitle\">Thème : Robots</h2>"
echo "            </div>"
echo "        </div>"
echo "    </section>"

# Section principale avec le tableau
echo "    <section class=\"section\">"
echo "        <div class=\"container\">"
echo "            <div class=\"buttons\">"
echo "                <a href=\"../../index.html\" class=\"button is-primary\">Retour à l'accueil</a>"
echo "            </div>"
echo "            <div class=\"table-container\">"
echo "                <table class=\"table is-striped is-hoverable is-fullwidth\">"
echo "                    <thead>"
echo "                        <tr>"
echo "                            <th>Numéro</th>"
echo "                            <th>URL</th>"
echo "                            <th>Code HTTP</th>"
echo "                            <th>Encodage</th>"
echo "                            <th>Nombre de mots</th>"
echo "                        </tr>"
echo "                    </thead>"
echo "                    <tbody>"

NUMERO_LIGNE=1

while read -r URL;
do
    # Récupérer le code HTTP
    HTTP_CODE=$(curl -I -L -s -o /dev/null -w "%{http_code}" "$URL")
    
    # Récupérer l'encodage
    ENCODAGE=$(curl -I -L -s "$URL" | grep -i "content-type" | grep -o "charset=[^;]*" | cut -d= -f2 | tr -d '\r\n' | head -n 1)
    
    # Si pas d'encodage trouvé, mettre "N/A"
    if [ -z "$ENCODAGE" ]; then
        ENCODAGE="N/A"
    fi
    
    # Compter les mots
    NB_MOTS=$(lynx -dump -nolist "$URL" 2>/dev/null | wc -w)
    
    # Choisir la classe CSS selon le code HTTP
    if [ "$HTTP_CODE" = "200" ]; then
        TR_CLASS="has-background-success-light"
    elif [ "$HTTP_CODE" = "404" ]; then
        TR_CLASS="has-background-warning-light"
    else
        TR_CLASS="has-background-danger-light"
    fi
    
    # Afficher une ligne du tableau HTML
    echo "                        <tr class=\"${TR_CLASS}\">"
    echo "                            <td>${NUMERO_LIGNE}</td>"
    echo "                            <td><a href=\"${URL}\" target=\"_blank\">${URL}</a></td>"
    echo "                            <td><span class=\"tag is-info\">${HTTP_CODE}</span></td>"
    echo "                            <td>${ENCODAGE}</td>"
    echo "                            <td>${NB_MOTS}</td>"
    echo "                        </tr>"
    
    NUMERO_LIGNE=$((NUMERO_LIGNE + 1))
    
done < "$FICHIER_URLS"

# Fin du tableau et de la page
echo "                    </tbody>"
echo "                </table>"
echo "            </div>"
echo "        </div>"
echo "    </section>"

echo "    <footer class=\"footer\">"
echo "        <div class=\"content has-text-centered\">"
echo "            <p><strong>Mini-projet PPE1</strong> - Sara CHALABI - 2024-2025</p>"
echo "        </div>"
echo "    </footer>"

echo "</body>"
echo "</html>"
